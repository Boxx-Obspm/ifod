%%----------------HEADER---------------------------%%
%Author:           Boris Segret
%Version & Date:   V1.1 10-04-2016 (dd/mm/yyyy)
%                  - produce Ephemeris in VTS-Format for a given body (target) from a given trajectory (source)
%CL=2
%Version & Date:
%                  V1.0 09-04-2016 (dd/mm/yyyy) Boris Segret
%
% I/: Sfpath, Tfpath: Source's and Target's trajectory files
%     - Sfpath (Source) is VTS-formatted
%     - Tfpath (Target) is IMCCE-formatted
% O/: VTS-formatted ephemerides of T from S, time stepped on S on the common time interval.
% F/: - S to T directions are expressed in latitudes, longitudes and distances
%     - light(travel is not taken into account

function outs = prodEPHfiles(Sfpath, Tfpath)
v_inputs = '2.0';

sf=fopen(Sfpath,'rt');
l=' ';
while 1
    l=fgetl(sf);
    if strfind(l,'META_STOP')>0
        break;
    end;
end;
sdata = fscanf(sf,'%f %f %f %f %f %f %f %f', [8 inf]);
sdata = sdata';
fclose(sf);

%epochs = sdata(:,1)+sdata(:,2)/86400.;
% not used here as the IMCCE file is synchronised on the SOURCE's epochs
tf=fopen(Tfpath,'rt');
l=' ';
while 1
    l=fgetl(tf);
    if strfind(l,'META_STOP')>0
        break;
    end;
end;
fprintf('ATTENTION: debut donnees IMCCE en colonne 33\n');
tdata = fscanf(tf,'%*33c %f, %f, %f, %f, %f, %f, %f', [7 inf]);
tdata = tdata';
fclose(tf);

uneAU = 149597870.7; % km (source obspm.fr, 29/01/2014)
nlgn  = min([size(sdata,1) size(tdata,1)]);
sdata = sdata(1:nlgn,1:5);
tdata = tdata(1:nlgn,1:3).*uneAU;

dr  = tdata(:,1:3)-sdata(:,3:5);
lat = atan(dr(:,3)./sqrt(dr(:,1).^2+dr(:,2).^2)).*180./pi();
% sign "-" because longitudes on the sky are in anti-trigonometric order
% lng =-(1-2*(dr(:,2)<0)).*acos(dr(:,1)./sqrt(dr(:,1).^2+dr(:,2).^2)).*180./pi();
lng =mod((1-2*(dr(:,2)<0)).*acos(dr(:,1)./sqrt(dr(:,1).^2+dr(:,2).^2)).*180./pi(),360.);
dst=sqrt(dr(:,1).^2+dr(:,2).^2+dr(:,3).^2);

outs = [sdata(:,1:2) lat lng dst];

ff=fopen([Tfpath '_vts.eph'],'w');
fprintf(ff,'NAV_input version : %s\nGenerated by BIRDY NAV TEAM\nDate : %s\n\n', v_inputs, datestr(now));
fprintf(ff,'TARGET_NAME : %s\nAS SEEN FROM : %s\nREFERENCE_FRAME : heliocentric ecliptic J2000\n\n', Tfpath, Sfpath);
fprintf(ff,'NO LIGHT-TRAVEL DELAY INCLUDED\n');
fprintf(ff,'META_START\n\n');
fprintf(ff,'COLUMN #01 : Day of the date (in MJD)\n');
fprintf(ff,'COLUMN #02 : Seconds in the day (in seconds)\n');
fprintf(ff,'COLUMN #03 : Latitude of the target body (in degrees)\n');
fprintf(ff,'COLUMN #04 : Longitude of the target body (in degrees)\n');
fprintf(ff,'COLUMN #05 : Distance of the target body (km)\n');
fprintf(ff,'\nMETA_STOP\n\n');

fprintf(ff, '%7i %13.6f %13.8f %13.8f %14.3f\n', outs');
fclose(ff);
end
